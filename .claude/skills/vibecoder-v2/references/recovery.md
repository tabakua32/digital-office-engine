# Recovery Patterns

<!-- PRIMACY: найкритичніші дії — перші -->

## Коли використовувати цей файл
- Claude робить ту саму помилку 2+ рази
- Відповіді суперечать попереднім інструкціям
- Claude редагує не ті файли або плутає структуру
- Прості задачі раптово потребують кількох спроб

---

## 1. Escape-послідовність для петлі

```
Esc → /rewind → "Restore code only" → re-prompt з явним обмеженням
```

Після `Esc`: Claude зазвичай сам погоджується що зайшов у глухий кут.
`/rewind` → "Restore code only" = зберігає розуміння мети, прибирає зламаний код.

Re-prompt шаблон:
```
Попередній підхід не спрацював: [опис].
Не повторюй його. Спробуй інший шлях: [напрямок].
```

---

## 2. Діагностика: 5 симптомів отруєння контексту

Claude повертається до відкинутих підходів → **moderate**
Відповіді суперечать ранішим інструкціям → **moderate**
Редагує не ті файли або плутає структуру → **moderate**
Прості речі потребують кількох спроб → **severe**
Рішення стають випадковими замість обґрунтованих → **severe**

### Три рівні відновлення

**Mild (1–2 симптоми, <70% контексту)**
```
/compact Фокус лише на [поточна задача]. Відкинь всю решту.
```

**Moderate (3+ симптоми або >70% контексту)**
```
/clear
/catchup    ← завантажує uncommitted git changes
```

**Severe (помилки після /clear)**
→ Перейди до протоколу Document & Clear (розділ 3).

### Порогові значення деградації

| Зона | % контексту | Дія |
|---|---|---|
| Зелена | 0–60% | Працюй вільно |
| Жовта | 60–70% | Плануй compact/clear |
| Червона | 70%+ | Compact або clear зараз |
| Критична | 90%+ | Нова сесія — compact не допоможе |

Моніторинг: `/context` (детально) або статус-бар (реальний час).

> Конфлікт джерел: Shrivu Shankar не рекомендує авто-compact, офіційна документація рекомендує. Узгодження: ручний `/compact <фокус>` при 65–70% працює; авто-compact при 95% — ненадійний.

---

## 3. Протокол Document & Clear (повний)

Використовуй при severe або перед плановою перервою.

**Крок 1 — Зафіксуй стан**
```
Перед тим як я очищу контекст, запиши детальний handoff у ./HANDOFF.md:
1. Мета задачі та загальний підхід
2. Що завершено (з шляхами файлів)
3. Що спробовано і не спрацювало (і чому)
4. Ключові рішення та їх обґрунтування
5. Поточний стан кодової бази
6. Точні наступні кроки
7. Відкриті питання або блокери
```

**Крок 2** — Переглянь HANDOFF.md. Додай що Claude пропустив.

**Крок 3** — `/clear`

**Крок 4 — Відновлення**
```
Прочитай ./HANDOFF.md і продовж з того місця де зупинились.
Підсумуй своє розуміння перед тим як продовжити.
Фокус: [конкретна наступна задача з handoff документу].
```

### /catchup slash-команда (зберегти як `.claude/commands/catchup.md`)

```markdown
---
description: Відновити контекст з uncommitted змін
allowed-tools: Bash, Read
---
Прочитай всі uncommitted git зміни в цій розмові.
Підсумуй що модифіковано та поточний стан реалізації.
```

Використання після clear: `/clear` → `/catchup` → продовжуй.

---

## 4. Захист від галюцинацій імпортів

Верифікаційний prompt (після підозрілого імпорту):
```
Зупинись. Перевір: ти використав [метод/API].
1. Це реальна фіча чи ти згенерував правдоподібне?
2. Оціни впевненість: певний / ймовірний / непевний
3. Яка документація підтверджує що це існує?
Краще визнати непевність ніж вигадати.
```

6 ознак галюцинації:
- Вигадує API-методи з ідеальним синтаксисом
- Генерує "надто зручні" фічі
- Робить конкретні claims про версії ("додано у v3.2")
- Відповіді відрізняються на одне і те ж питання
- Вигадує деталі з раніше в довгій розмові
- Приписує фічі однієї бібліотеки іншій

**Системне вирішення** — додай у CLAUDE.md:
```markdown
## Import Verification Rules
- After any code change, run: `npm run typecheck`
- Never guess API signatures — read the actual source file first
- Before importing: `grep -r "export.*FunctionName" src/`
- If import fails: read module's index file to see available exports
```

---

## 5. Git safety nets

**Worktrees — єдиний найбільший unlock продуктивності (Борис Черни)**

```bash
git worktree add ../project-feature-a feature-branch-a
git worktree add ../project-bugfix-b bugfix-branch-b
```

Природна ізоляція: якщо одна сесія зламалась — інші не постраждали.

**Правила у CLAUDE.md для git безпеки:**
```markdown
## Git Safety Protocol
- Before risky refactor: git add -A && git commit -m "checkpoint: before [опис]"
- Commit after each completed sub-task
- Never run git reset --hard or git clean -fd without explicit user confirmation
- Never pipe to /dev/null to hide errors
```

**Автоматичні checkpoints** — Claude Code створює Git-based checkpoint перед кожним редагуванням файлу. Доступ: `Esc+Esc` або `/rewind`. Зберігаються 30 днів.

---

<!-- RECENCY: повторення критичного -->

## Швидка довідка

```
Петля → Esc → /rewind → code-only → re-prompt з іншим підходом
Деградація → /context → при 70%+ → /compact або /clear
Severe → HANDOFF.md → /clear → /catchup
Галюцинації → typecheck → verification prompt → читай source
```
